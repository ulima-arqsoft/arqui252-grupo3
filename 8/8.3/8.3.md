> [8. Aplicaci√≥n de Patrones Arquitecturales](../8.md) ‚Ä∫ [8.3. M√≥dulo 3 / Integrante 3](8.3.md)

# 8.3. Patrones del M√≥dulo Compras

## **Decisi√≥n 1: Patr√≥n State Machine**

**T√≠tulo:**  
Gesti√≥n de flujo de aprobaci√≥n de √≥rdenes de compra mediante State Machine

**Contexto:**  
Las √≥rdenes de compra de InnovaLogix siguen un flujo de estados: BORRADOR ‚Üí PENDIENTE_APROBACION ‚Üí APROBADA ‚Üí RECIBIDA ‚Üí COMPLETADA (o RECHAZADA). Cada transici√≥n tiene reglas espec√≠ficas: solo Administrador/Gerente aprueba, solo √≥rdenes aprobadas se env√≠an a proveedores, recepci√≥n actualiza inventario autom√°ticamente. Se requiere garantizar transiciones v√°lidas y ejecutar acciones autom√°ticas por estado.

**Alternativas:**
1. **Condicionales if/else:**
   - Validaciones de transiciones con condicionales
   - L√≥gica dispersa en m√∫ltiples m√©todos
   - Dificulta agregar estados
   - Errores en transiciones inv√°lidas

2. **Patr√≥n State Machine:**
   - Cada estado es clase con transiciones permitidas
   - Acciones autom√°ticas en entrada/salida de estado
   - Validaci√≥n centralizada de transiciones
   - Facilita auditor√≠a de cambios de estado

3. **Workflow Engine:**
   - Motor de flujos complejos
   - Sobrecarga para flujo lineal
   - Dependencia externa adicional

**Criterios de elecci√≥n:**
- **Validaci√≥n:** Garant√≠a de transiciones v√°lidas
- **Automatizaci√≥n:** Acciones por estado
- **Auditabilidad:** Trazabilidad de cambios
- **Mantenibilidad:** Agregar estados f√°cilmente

**Decisi√≥n:**
Patr√≥n State Machine.

- **Estados:** DraftState, PendingApprovalState, ApprovedState, ReceivedState, CompletedState, RejectedState
- **Transiciones validadas:** Cada estado define estados destino permitidos
- **Acciones autom√°ticas:** onEnter (notificar aprobador, enviar a proveedor, actualizar stock)

**Sustento:**  
State Machine garantiza que √≥rdenes sigan flujo correcto sin transiciones inv√°lidas. Al pasar a PENDIENTE_APROBACION, autom√°ticamente notifica al aprobador. Al pasar a APROBADA, env√≠a orden al proveedor. Al pasar a RECIBIDA, actualiza inventario y registra entrada en kardex. Centraliza reglas de transici√≥n facilitando agregar estados (ej: PARCIALMENTE_RECIBIDA). Cumple con QAW-10 (auditabilidad) registrando cada cambio de estado con timestamp y usuario.

<!-- INSERTAR IMAGEN ACERCA DE: Diagrama de estados de orden de compra mostrando transiciones v√°lidas entre BORRADOR, PENDIENTE, APROBADA, RECIBIDA, COMPLETADA -->

---

## **Decisi√≥n 2: Patr√≥n Aggregate**

**T√≠tulo:**  
Gesti√≥n de consistencia de √≥rdenes de compra mediante Aggregate

**Contexto:**  
Una orden de compra tiene m√∫ltiples √≠tems (productos con cantidades), cada uno afectando inventario al recibirla. Se requiere garantizar consistencia: no permitir modificar √≠tems de orden aprobada, actualizar total al agregar/remover √≠tems, validar stock al recepcionar. La orden y sus √≠tems deben tratarse como unidad transaccional.

**Alternativas:**
1. **Gesti√≥n independiente:**
   - Orden e √≠tems como entidades separadas
   - F√°cil inconsistencia (√≠tems sin orden, totales incorrectos)
   - L√≥gica de validaci√≥n dispersa

2. **Patr√≥n Aggregate:**
   - Orden como ra√≠z del agregado
   - √çtems solo accesibles v√≠a orden
   - Validaciones centralizadas en agregado
   - Transacciones at√≥micas

3. **Transaction Script:**
   - Scripts espec√≠ficos por operaci√≥n
   - Duplicaci√≥n de validaciones
   - Dificulta mantener invariantes

**Criterios de elecci√≥n:**
- **Consistencia:** Mantener invariantes del negocio
- **Atomicidad:** Operaciones todo-o-nada
- **Encapsulamiento:** L√≥gica de validaci√≥n centralizada
- **Integridad:** Prevenci√≥n de estados inv√°lidos

**Decisi√≥n:**
Patr√≥n Aggregate con Orden como ra√≠z.

- **Ra√≠z:** OrdenCompra con m√©todos agregarItem(), removerItem(), aprobar(), recepcionar()
- **Entidades internas:** ItemOrden (solo modificables v√≠a OrdenCompra)
- **Invariantes:** Total = suma √≠tems, √≠tems no modificables si orden aprobada, stock validado al recepcionar

**Sustento:**  
Aggregate garantiza que orden e √≠tems mantengan consistencia. Al agregar √≠tem, orden recalcula total autom√°ticamente. Al intentar modificar orden aprobada, lanza excepci√≥n. Al recepcionar, valida todos los √≠tems at√≥micamente y actualiza inventario en transacci√≥n √∫nica. Si falla actualizaci√≥n de un √≠tem, toda la recepci√≥n se revierte. Cumple con QAW-01 (disponibilidad) evitando estados inconsistentes que requieran correcci√≥n manual.

<!-- INSERTAR IMAGEN ACERCA DE: Diagrama mostrando OrdenCompra como agregado root conteniendo ItemOrden y m√©todos de operaci√≥n -->

---

[‚¨ÖÔ∏è Anterior](../8.2/8.2.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../8.4/8.4.md)
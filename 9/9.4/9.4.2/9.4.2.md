> [9. MetodologÃ­a de DiseÃ±o de Arquitectura - AplicaciÃ³n de ADD](../../9.md) â€º [9.4. IteraciÃ³n 3: Refinar estructuras para abordar el atributo de calidad mÃ¡s importante](../9.4.md) â€º [9.4.2. Elementos a refinar](9.4.2.md)

# 9.4.2. Elementos a refinar

## Elementos ArquitectÃ³nicos a Refinar en la IteraciÃ³n 3

Esta iteraciÃ³n se concentra en refinar los elementos arquitectÃ³nicos relacionados con la **disponibilidad, consistencia y rendimiento en tiempo real** del sistema InnovaLogix Retail ERP. A continuaciÃ³n se detallan los componentes especÃ­ficos que requieren refinamiento:

### 1. Sistema de ComunicaciÃ³n en Tiempo Real

El sistema de notificaciones bidireccionales basado en WebSocket requiere refinamiento para garantizar:

- **GestiÃ³n de conexiones persistentes:** Manejo eficiente de hasta 50 conexiones simultÃ¡neas por instancia del servidor Node.js, con heartbeat automÃ¡tico cada 25 segundos para detectar conexiones zombie y liberaciÃ³n proactiva de recursos.

- **PropagaciÃ³n de eventos de dominio:** Mecanismo de broadcast selectivo que permite emitir eventos a grupos especÃ­ficos de usuarios segÃºn su rol y mÃ³dulo activo, evitando saturaciÃ³n de clientes con notificaciones irrelevantes.

- **RecuperaciÃ³n ante fallos:** Estrategia de reconexiÃ³n automÃ¡tica con backoff exponencial que intenta reconectar en intervalos de 1, 2, 4, 8 y 16 segundos, con fallback a polling HTTP cada 30 segundos si WebSocket no estÃ¡ disponible.

- **Buffer de eventos pendientes:** Cola en memoria que retiene hasta 100 eventos no entregados por cliente desconectado, con sincronizaciÃ³n automÃ¡tica al reconectar dentro de ventana de 5 minutos.

### 2. Capa de CachÃ© con InvalidaciÃ³n Inteligente

La estrategia de caching mediante node-cache necesita refinamiento en:

- **PolÃ­ticas de expiraciÃ³n diferenciadas:** TTL de 10 minutos para lista completa de productos, 30 minutos para categorÃ­as y proveedores, 5 minutos para datos de stock agregado por categorÃ­a.

- **InvalidaciÃ³n selectiva sincronizada:** Mecanismo que invalida entradas especÃ­ficas del cache al ocurrir escrituras en base de datos, manteniendo consistencia eventual inferior a 100 milisegundos entre cache y PostgreSQL.

- **Cache warming estratÃ©gico:** Precarga automÃ¡tica de productos mÃ¡s consultados al iniciar servidor, basada en ranking histÃ³rico de bÃºsquedas de los Ãºltimos 30 dÃ­as.

- **MÃ©tricas de efectividad:** InstrumentaciÃ³n que registra hit rate, miss rate, latencia de lectura y tasa de invalidaciones para optimizaciÃ³n continua.

### 3. Arquitectura de Eventos de Dominio

El sistema Event-Driven que conecta mÃ³dulos mediante eventos requiere refinamiento en:

- **CatÃ¡logo de eventos estandarizado:** DefiniciÃ³n formal de 12 eventos de dominio con schemas versionados: `stockUpdate`, `productCreated`, `productDeleted`, `saleCompleted`, `lowStockAlert`, `purchaseReceived`, `customerCreated`, `supplierUpdated`, `reportGenerated`, `userLoggedIn`, `inventoryAdjusted`, `priceChanged`.

- **Event Bus centralizado:** Componente singleton que actÃºa como mediador entre productores y consumidores de eventos, permitiendo suscripciones dinÃ¡micas por tipo de evento y rol de usuario.

- **Persistencia de eventos crÃ­ticos:** Tabla `domain_events` en PostgreSQL que registra eventos de auditorÃ­a (cambios de stock, ventas, compras) con timestamp, usuario responsable, datos antes/despuÃ©s para trazabilidad completa.

- **Handlers asÃ­ncronos desacoplados:** SeparaciÃ³n clara entre emisiÃ³n de evento (sÃ­ncrona con la operaciÃ³n CRUD) y procesamiento de handlers (asÃ­ncrono en background), evitando bloqueo de transacciones crÃ­ticas.

### 4. Transacciones ACID y Consistencia de Datos

Las operaciones de escritura crÃ­ticas en PostgreSQL requieren refinamiento en:

- **Niveles de aislamiento apropiados:** Uso de `READ COMMITTED` para operaciones estÃ¡ndar y `SERIALIZABLE` para ajustes manuales de inventario que requieren consistencia absoluta.

- **Manejo de deadlocks:** Estrategia de retry automÃ¡tico con mÃ¡ximo 3 intentos y backoff de 100ms entre reintentos para operaciones que fallen por conflictos de bloqueo.

- **Validaciones pre-transaccionales:** VerificaciÃ³n de precondiciones de negocio antes de iniciar transacciÃ³n para reducir tasa de rollbacks y mejorar throughput.

- **Checkpoints de recuperaciÃ³n:** Puntos de guardado intermedios en transacciones largas que permiten rollback parcial sin descartar toda la operaciÃ³n.

### 5. Soporte Offline y SincronizaciÃ³n Diferida

El modo offline del mÃ³dulo POS basado en PWA requiere refinamiento en:

- **Estrategia de almacenamiento local:** Uso de IndexedDB con schema estructurado que replica tablas crÃ­ticas (productos, precios, clientes frecuentes) con lÃ­mite de 50MB por origen.

- **Cola de operaciones pendientes:** Estructura FIFO persistente que almacena ventas, ajustes y cambios realizados offline con timestamp y hash de integridad para detecciÃ³n de manipulaciÃ³n.

- **SincronizaciÃ³n incremental:** Algoritmo que envÃ­a solo deltas al reconectar, comparando timestamps locales con servidor para minimizar ancho de banda en sincronizaciÃ³n.

- **ResoluciÃ³n de conflictos:** PolÃ­tica "Ãºltima escritura gana" con alertas visuales cuando se detectan cambios concurrentes del mismo recurso, permitiendo revisiÃ³n manual de discrepancias crÃ­ticas.

### 6. Monitoreo y Observabilidad en Tiempo Real

La instrumentaciÃ³n del sistema para garantizar cumplimiento de SLOs requiere:

- **MÃ©tricas de latencia por endpoint:** Registro de percentiles P50, P95, P99 en operaciones crÃ­ticas (bÃºsqueda de productos, registro de ventas, actualizaciÃ³n de stock) con alertas cuando P95 excede umbrales definidos.

- **Dashboards de salud del sistema:** VisualizaciÃ³n en tiempo real de conexiones WebSocket activas, tamaÃ±o de colas de eventos, hit rate de cache, tasa de errores HTTP, y operaciones offline pendientes.

- **Trazas distribuidas:** CorrelaciÃ³n de requests HTTP con eventos WebSocket emitidos para debugging de flujos end-to-end en escenarios multi-usuario.

- **Alertas proactivas:** Notificaciones automÃ¡ticas cuando mÃ©tricas crÃ­ticas degradan: latencia P95 >500ms, tasa de entrega de eventos <99%, tasa de error >1%, conexiones activas >80% capacidad.

---

[â¬…ï¸ Anterior](../9.4.1/9.4.1.md) | [ğŸ  Home](../../../README.md) | [Siguiente â¡ï¸](../9.4.3/9.4.3.md)
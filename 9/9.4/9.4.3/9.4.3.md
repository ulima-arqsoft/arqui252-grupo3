> [9. Metodolog√≠a de Dise√±o de Arquitectura - Aplicaci√≥n de ADD](../../9.md) ‚Ä∫ [9.4. Iteraci√≥n 3: Refinar estructuras para abordar el atributo de calidad m√°s importante](../9.4.md) ‚Ä∫ [9.4.3. Conceptos de dise√±o](9.4.3.md)

# 9.4.3. Conceptos de dise√±o

## Conceptos de Dise√±o para Disponibilidad y Consistencia en Tiempo Real

Esta secci√≥n documenta las decisiones arquitect√≥nicas refinadas para garantizar disponibilidad, consistencia y rendimiento en tiempo real del sistema InnovaLogix Retail ERP.

---

### DEC-RT-01: Event-Driven Architecture con Socket.IO

**Concepto:** Arquitectura orientada a eventos que propaga cambios de estado mediante WebSocket bidireccional, permitiendo sincronizaci√≥n en tiempo real entre m√∫ltiples usuarios sin polling.

**Decisi√≥n:** Implementar Event-Driven Architecture utilizando Socket.IO versi√≥n 4.8 como capa de transporte, con eventos de dominio tipados y room-based broadcasting para segmentaci√≥n de notificaciones.

**Justificaci√≥n:**

1. **Latencia ultra-baja:** Socket.IO mantiene conexiones persistentes TCP que eliminan overhead de handshake HTTP en cada mensaje, logrando latencias inferiores a 100 milisegundos para propagaci√≥n de eventos entre servidor y clientes.

2. **Bidireccionalidad nativa:** A diferencia de Server-Sent Events que solo permite flujo servidor-cliente, Socket.IO soporta comunicaci√≥n bidireccional permitiendo que clientes emitan eventos al servidor sin necesidad de requests HTTP separados.

3. **Fallback autom√°tico a polling:** Si WebSocket no est√° disponible por restricciones de red o firewall corporativo, Socket.IO degrada gracefully a long-polling HTTP sin cambios en c√≥digo cliente, garantizando compatibilidad universal.

4. **Rooms para broadcasting selectivo:** Capacidad de agrupar conexiones en rooms l√≥gicos permite emitir eventos solo a usuarios relevantes, por ejemplo enviar `stockUpdate` solo a usuarios con m√≥dulo POS o Inventario abierto, reduciendo tr√°fico innecesario.

5. **Reconexi√≥n autom√°tica resiliente:** Biblioteca cliente maneja reconexi√≥n autom√°tica con backoff exponencial ante desconexiones temporales, sin intervenci√≥n manual del usuario ni p√©rdida de estado de aplicaci√≥n.

**Patrones arquitect√≥nicos aplicados:**
- Event-Driven Architecture
- Publisher-Subscriber Pattern
- Observer Pattern (clientes observan eventos del servidor)
- Facade Pattern (Socket.IO abstrae complejidad de WebSocket)

**Escenarios que resuelve:**
- QAW-01: Disponibilidad mediante notificaciones de reconexi√≥n
- QAW-02: Rendimiento con latencia <100ms en propagaci√≥n de cambios
- REF-07: Interoperabilidad entre m√≥dulos mediante eventos desacoplados

---

### DEC-RT-02: Cache-Aside Pattern con node-cache

**Concepto:** Estrategia de caching en memoria que intercepta lecturas frecuentes, consultando cache primero y fallback a base de datos solo en caso de miss, con invalidaci√≥n sincronizada en escrituras.

**Decisi√≥n:** Implementar patr√≥n Cache-Aside utilizando node-cache con pol√≠ticas de TTL diferenciadas por tipo de dato, invalidaci√≥n expl√≠cita en operaciones de escritura, y m√©tricas de efectividad instrumentadas.

**Justificaci√≥n:**

1. **Reducci√≥n de latencia en lecturas:** Cache en memoria RAM responde en 1-5 milisegundos versus 50-100 milisegundos de PostgreSQL, mejorando percentil 95 de latencia en endpoints de consulta frecuente como b√∫squeda de productos.

2. **Descarga de base de datos:** Hit rate objetivo de 75% significa que 3 de cada 4 consultas se resuelven sin tocar PostgreSQL, reduciendo carga en DB y liberando conexiones del pool para operaciones de escritura cr√≠ticas.

3. **Simplicidad operacional:** node-cache es biblioteca ligera sin dependencias externas que no requiere infraestructura adicional como Redis, simplificando deployment y reduciendo puntos de fallo.

4. **Control granular de expiraci√≥n:** TTL diferenciado permite optimizar balance entre frescura de datos y performance, por ejemplo 5 minutos para stock que cambia frecuentemente versus 30 minutos para categor√≠as que son relativamente est√°ticas.

5. **Invalidaci√≥n determinista:** Al invalidar cache expl√≠citamente en cada escritura mediante delete de keys afectadas, se garantiza consistencia eventual con ventana inferior a 100 milisegundos entre actualizaci√≥n en DB y reflejo en cache.

**Trade-offs aceptados:**
- Cache no compartido entre instancias del servidor (aceptable en deployment single-instance inicial)
- Consistencia eventual con ventana de hasta 100ms (aceptable para dominio retail no cr√≠tico)
- L√≠mite de memoria del proceso Node.js (estimado 50-100MB para 5000 productos)

**Escenarios que resuelve:**
- ESC-13: Rendimiento en b√∫squeda de productos con 10k items en <1s
- ESC-27: Consulta de inventario de 500 productos en <2s
- QAW-02: Mejora de percentil 95 de latencia a <200ms

---

### DEC-RT-03: Transacciones ACID con Manejo de Deadlocks

**Concepto:** Uso riguroso de transacciones PostgreSQL con niveles de aislamiento apropiados, retry autom√°tico ante deadlocks, y validaciones pre-transaccionales para optimizar tasa de commit.

**Decisi√≥n:** Envolver todas las operaciones de escritura cr√≠ticas en transacciones expl√≠citas BEGIN-COMMIT-ROLLBACK, con nivel de aislamiento READ COMMITTED por defecto y SERIALIZABLE para ajustes manuales de inventario, implementando retry con backoff exponencial hasta 3 intentos.

**Justificaci√≥n:**

1. **Atomicidad garantizada:** Transacciones aseguran que operaciones multi-paso como "registrar venta + actualizar stock + generar comprobante" se ejecutan completamente o no se ejecutan en absoluto, previniendo estados inconsistentes.

2. **Prevenci√≥n de race conditions:** Nivel de aislamiento READ COMMITTED previene lecturas sucias donde un cajero vea stock que otra transacci√≥n a√∫n no ha confirmado, evitando sobreventa de productos.

3. **Recuperaci√≥n autom√°tica ante conflictos:** Deadlocks ocasionales por actualizaciones concurrentes del mismo producto se resuelven autom√°ticamente mediante retry con backoff de 100ms-200ms-400ms, transparente para usuario final.

4. **Consistencia referencial:** Foreign keys y constraints de PostgreSQL validados dentro de transacci√≥n garantizan integridad entre tablas relacionadas como ventas-detalles_venta-productos.

5. **Auditor√≠a completa:** Tabla domain_events poblada dentro de misma transacci√≥n asegura que cada cambio de estado tiene registro de auditor√≠a correspondiente, sin posibilidad de desincronizaci√≥n.

**Implementaci√≥n de retry logic:**
- Intento 1: Ejecuci√≥n inmediata
- Intento 2: Espera 100ms + ejecuci√≥n
- Intento 3: Espera 200ms + ejecuci√≥n
- Si falla despu√©s de 3 intentos: Retornar error HTTP 409 Conflict con mensaje descriptivo

**Escenarios que resuelve:**
- ESC-18: Confiabilidad ante ca√≠da de conexi√≥n durante actualizaci√≥n
- CONS-09: Prevenci√≥n de duplicidad de datos tras desconexi√≥n
- REF-08: Recuperaci√≥n correcta de transacciones interrumpidas

---

### DEC-RT-04: PWA con IndexedDB para Modo Offline

**Concepto:** Progressive Web App que utiliza Service Workers para cachear recursos est√°ticos e IndexedDB para almacenar datos transaccionales localmente, permitiendo operaci√≥n continua sin conexi√≥n a internet.

**Decisi√≥n:** Registrar Service Worker que cachea HTML, CSS, JS y assets con estrategia cache-first, almacenar productos y clientes frecuentes en IndexedDB con l√≠mite 50MB, implementar cola FIFO persistente para operaciones offline, y sincronizar autom√°ticamente al detectar reconexi√≥n.

**Justificaci√≥n:**

1. **Continuidad operativa cr√≠tica:** En ferias o eventos outdoor donde internet es inestable, cajeros deben poder registrar ventas sin interrupci√≥n, con sincronizaci√≥n posterior al retornar a zona con cobertura.

2. **Experiencia de usuario consistente:** Service Worker permite que aplicaci√≥n cargue instant√°neamente incluso sin red, mostrando interfaz completa con indicador visual de modo offline en lugar de p√°gina en blanco de error de conexi√≥n.

3. **Almacenamiento generoso:** IndexedDB soporta hasta 50MB por origen en mayor√≠a de browsers modernos, suficiente para cachear 5000 productos con im√°genes thumbnail e informaci√≥n de precios.

4. **Persistencia garantizada:** A diferencia de localStorage que puede ser limpiado agresivamente por browser, IndexedDB es persistente y no se elimina autom√°ticamente bajo presi√≥n de memoria.

5. **Sincronizaci√≥n inteligente:** Cola de operaciones pendientes con timestamps permite enviar solo deltas al servidor, minimizando ancho de banda en sincronizaci√≥n y detectando conflictos mediante comparaci√≥n de versiones.

**Estrategia de sincronizaci√≥n:**
1. Detector de conectividad online/offline basado en evento `navigator.onLine`
2. Al detectar reconexi√≥n, enviar operaciones de cola FIFO en orden cronol√≥gico
3. Para cada operaci√≥n: verificar si recurso fue modificado en servidor durante desconexi√≥n
4. Si hay conflicto: mostrar modal con datos local vs servidor para resoluci√≥n manual
5. Si no hay conflicto: aplicar cambio y marcar operaci√≥n como sincronizada
6. Al completar cola: refrescar datos locales con snapshot actualizado del servidor

**Escenarios que resuelve:**
- QAW-01: Disponibilidad del POS durante ca√≠da de internet de hasta 30 minutos
- ESC-03: Tolerancia a errores con guardado local y sincronizaci√≥n diferida
- REF-03: Manejo de errores cuando m√≥dulo de inventario temporalmente inaccesible

---

### DEC-RT-05: Monitoreo con M√©tricas de Latencia Percentiladas

**Concepto:** Instrumentaci√≥n de endpoints cr√≠ticos para registrar latencias en percentiles P50, P95, P99, con dashboards en tiempo real y alertas autom√°ticas cuando m√©tricas degradan m√°s all√° de umbrales SLO.

**Decisi√≥n:** Implementar middleware Express que registra timestamps al inicio y fin de request, calculando latencias agregadas en ventanas deslizantes de 1 minuto, almacenando m√©tricas en tabla time-series PostgreSQL con retenci√≥n de 30 d√≠as, y exponiendo dashboard web con gr√°ficos de l√≠neas para visualizaci√≥n de tendencias.

**Justificaci√≥n:**

1. **Visibilidad proactiva:** M√©tricas en tiempo real permiten detectar degradaciones de performance antes que usuarios reporten problemas, facilitando investigaci√≥n proactiva de cuellos de botella.

2. **Percentiles m√°s representativos que promedio:** P95 y P99 revelan experiencia de "worst case" que promedios ocultan, por ejemplo latencia promedio 100ms puede coexistir con P99 de 2 segundos indicando problema intermitente.

3. **Alertas basadas en SLOs:** Umbrales definidos en t√©rminos de atributos de calidad permiten alertar cuando sistema viola garant√≠as de performance comprometidas con stakeholders.

4. **Correlaci√≥n de m√©tricas:** Dashboard unificado que muestra latencias de API, conexiones WebSocket activas, hit rate de cache, y tasa de errores permite identificar relaciones causa-efecto en degradaciones.

5. **Datos para optimizaci√≥n:** Hist√≥rico de m√©tricas gu√≠a decisiones de optimizaci√≥n basadas en datos reales en lugar de intuici√≥n, por ejemplo identificar endpoints que justifican inversi√≥n en caching adicional.

**M√©tricas clave instrumentadas:**
- Latencia P50, P95, P99 de endpoints GET /api/products (b√∫squeda)
- Latencia P50, P95, P99 de endpoints POST /api/sales (registro ventas)
- Latencia P50, P95, P99 de endpoints PUT /api/inventory (actualizaci√≥n stock)
- Conexiones WebSocket activas por segundo
- Eventos Socket.IO emitidos por segundo
- Hit rate y miss rate de node-cache
- Tasa de errores HTTP 5xx y 4xx
- Operaciones offline pendientes de sincronizaci√≥n
- Tama√±o de cola de eventos por consumidor

**Umbrales de alerta configurados:**
- P95 latencia b√∫squeda >500ms: Alerta Warning
- P95 latencia registro ventas >1s: Alerta Warning
- P99 cualquier endpoint >2s: Alerta Critical
- Tasa de error >1% en ventana de 5 minutos: Alerta Critical
- Conexiones WebSocket >80% capacidad: Alerta Warning

**Escenarios que resuelve:**
- QAW-02: Garant√≠a de rendimiento con m√©tricas observables
- ESC-05: Eficiencia bajo alta carga con monitoreo proactivo
- Todos los escenarios de rendimiento mediante visibilidad de cumplimiento SLO

---

[‚¨ÖÔ∏è Anterior](../9.4.2/9.4.2.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../9.4.4/9.4.4.md)
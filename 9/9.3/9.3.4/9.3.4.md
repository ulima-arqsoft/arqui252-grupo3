> [9. Metodolog√≠a de Dise√±o de Arquitectura - Aplicaci√≥n de ADD](../../9.md) ‚Ä∫ [9.3. Iteraci√≥n 2: Identificar estructuras para soportar la funcionalidad primaria](../9.3.md) ‚Ä∫ [9.3.4. Elementos instanciados](9.3.4.md)

# 9.3.4. Elementos instanciados

<h1>9.3.4. Elementos instanciados</h1>

<p>
Esta secci√≥n describe los elementos arquitect√≥nicos concretos que se instancian durante la Iteraci√≥n 2 del proceso ADD.  
El objetivo es habilitar completamente la <strong>funcionalidad primaria</strong> del sistema: 
<strong>Inventario, Validaci√≥n de Stock, Kardex, Integraci√≥n POS ‚Üî Inventory, Seguridad y Consistencia de Datos</strong>.
</p>

<hr>

<h2>1. Componentes Instanciados del Inventory Service</h2>

<h3>Backend (L√≥gica y Servicios)</h3>

<ul>
  <li><strong>ProductController</strong> ‚Äì Manejo de productos y variantes.</li>
  <li><strong>StockController</strong> ‚Äì Endpoints para validar, incrementar y decrementar stock.</li>
  <li><strong>KardexController</strong> ‚Äì Gesti√≥n del log hist√≥rico de movimientos.</li>
  <li><strong>ProductService</strong> ‚Äì L√≥gica del cat√°logo y validaciones de SKU.</li>
  <li><strong>StockService</strong> ‚Äì Actualizaci√≥n transaccional del stock.</li>
  <li><strong>KardexService</strong> ‚Äì Registro inmutable de entradas/salidas.</li>
  <li><strong>AlertService</strong> ‚Äì Detecci√≥n de stock m√≠nimo y emisi√≥n de eventos.</li>
  <li><strong>CacheService</strong> ‚Äì Cache en memoria (node-cache) para cat√°logos y stock.</li>
  <li><strong>InventoryRepository</strong> ‚Äì Acceso a PostgreSQL mediante consultas parametrizadas.</li>
</ul>

<h3>Modelos de Datos</h3>

<ul>
  <li><strong>Producto</strong> (id, nombre, descripci√≥n, categor√≠a, estado)</li>
  <li><strong>Variante</strong> (id, producto_id, sku, talla/color, precio_unitario)</li>
  <li><strong>Stock</strong> (id, variante_id, cantidad, stock_minimo, ubicaci√≥n)</li>
  <li><strong>Kardex</strong> (id, variante_id, tipo_movimiento, cantidad, referencia, usuario_id, fecha, saldo_resultante)</li>
</ul>

<h3>Eventos Instanciados</h3>

<ul>
  <li><code>StockUpdated</code></li>
  <li><code>StockLow</code></li>
  <li><code>KardexRecorded</code></li>
</ul>

<h3>Consultas Optimizadas</h3>

<pre><code>CREATE INDEX idx_sku ON variantes(sku);
CREATE INDEX idx_producto ON productos(nombre);
CREATE INDEX idx_kardex_fecha ON kardex(fecha);
</code></pre>

<hr>

<h2>2. Componentes Instanciados del POS Service</h2>

<h3>Backend</h3>

<ul>
  <li><strong>SalesController</strong> ‚Äì Registro de ventas.</li>
  <li><strong>SalesService</strong> ‚Äì C√°lculo de totales, impuestos y validaci√≥n.</li>
  <li><strong>StockValidationClient</strong> ‚Äì Cliente REST para consultar stock en Inventory.</li>
  <li><strong>SalesRepository</strong> ‚Äì Transacciones SQL para registrar ventas y detalles.</li>
  <li><strong>EventsPublisher</strong> ‚Äì Emisi√≥n de <code>SaleCompleted</code> hacia Inventory.</li>
</ul>

<h3>Modelos de Datos</h3>

<ul>
  <li><strong>Venta</strong> (id, fecha, total, usuario_id, cliente_id)</li>
  <li><strong>DetalleVenta</strong> (id, venta_id, variante_id, cantidad, precio_unitario)</li>
</ul>

<h3>Eventos Emitidos</h3>

<ul>
  <li><code>SaleCompleted</code> ‚Äì Dispara actualizaci√≥n de stock.</li>
</ul>

<hr>

<h2>3. Elementos Instanciados de Comunicaci√≥n POS ‚Üî Inventory</h2>

<h3>Endpoints REST Instanciados</h3>

<ul>
  <li><code>GET /inventory/stock/:sku</code></li>
  <li><code>POST /inventory/validate</code></li>
  <li><code>POST /inventory/stock/decrement</code></li>
  <li><code>POST /inventory/stock/increment</code></li>
  <li><code>POST /inventory/kardex</code></li>
</ul>

<h3>L√≥gica de Transacciones</h3>

<p>Se define un flujo transaccional seguro:</p>

<ol>
  <li>Consulta de stock (con cache).</li>
  <li>Validaci√≥n de stock disponible.</li>
  <li>Lock transaccional (<code>SELECT ... FOR UPDATE</code>).</li>
  <li>Descuento del stock.</li>
  <li>Registro de movimiento en Kardex.</li>
  <li>Emisi√≥n de evento <code>StockUpdated</code>.</li>
</ol>

<hr>

<h2>4. Componentes de Seguridad Instanciados</h2>

<ul>
  <li><strong>ValidationMiddleware</strong> ‚Äì Validaci√≥n JOI para entradas de stock.</li>
  <li><strong>SQLSanitizer</strong> ‚Äì Parametrizaci√≥n estricta en PostgreSQL.</li>
  <li><strong>RateLimitMiddleware</strong> ‚Äì Protecci√≥n de rutas cr√≠ticas en Gateway.</li>
  <li><strong>ErrorHandlerMiddleware</strong> ‚Äì Manejo centralizado de errores.</li>
</ul>

<hr>

<h2>5. Cache Instanciado (node-cache)</h2>

<h3>Entradas cacheadas</h3>

<ul>
  <li>Cat√°logo de productos (TTL 10 minutos)</li>
  <li>Stock por variante (TTL 1 minuto)</li>
</ul>

<h3>Estados del Cache</h3>

<ul>
  <li><strong>Cache Hit</strong> ‚Üí respuesta inmediata (&lt;10 ms)</li>
  <li><strong>Cache Miss</strong> ‚Üí consulta a DB y almacenamiento</li>
  <li><strong>Invalidaci√≥n autom√°tica</strong> por TTL o modificaci√≥n de producto</li>
</ul>

<hr>

<h2>6. Componentes de WebSocket Instanciados</h2>

<ul>
  <li><strong>SocketServer</strong> ‚Äì Configuraci√≥n central de Socket.IO.</li>
  <li><strong>StockEventEmitter</strong> ‚Äì Emite eventos de stock actualizado.</li>
  <li><strong>LowStockNotifier</strong> ‚Äì Env√≠a <code>lowStockAlert</code> a clientes conectados.</li>
</ul>

<h3>Eventos WebSocket</h3>

<ul>
  <li><code>stockUpdate</code> ‚Äì Enviado cuando cambia el stock.</li>
  <li><code>lowStockAlert</code> ‚Äì Alerta al personal cuando stock &lt; m√≠nimo.</li>
</ul>

<hr>

<h2>7. Infraestructura Instanciada</h2>

<ul>
  <li><strong>PostgreSQL por servicio</strong> (Inventory, POS, Purchases).</li>
  <li><strong>APIs separadas</strong> en puertos 3001‚Äì3004.</li>
  <li><strong>API Gateway</strong> en puerto 3000 con rate limiting.</li>
  <li><strong>Socket.IO</strong> activo en Inventory y POS.</li>
</ul>

<hr>

<h2>8. Resumen General de Elementos Instanciados</h2>

<table>
<thead>
<tr>
  <th>√Årea</th>
  <th>Instancias creadas</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Inventory</td>
  <td>Controllers, Services, Repositorios, Cache, KardexService, AlertService</td>
</tr>
<tr>
  <td>POS</td>
  <td>SalesController, SalesService, validaci√≥n de stock, eventos SaleCompleted</td>
</tr>
<tr>
  <td>Comunicaci√≥n</td>
  <td>REST endpoints + eventos internos + WebSocket</td>
</tr>
<tr>
  <td>Seguridad</td>
  <td>Rate limiting, SQL parametrizado, validaciones JOI</td>
</tr>
<tr>
  <td>Infraestructura</td>
  <td>PostgreSQL por servicio, API Gateway, Socket.IO</td>
</tr>
</tbody>
</table>


[‚¨ÖÔ∏è Anterior](../9.3.3/9.3.3.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../9.3.5/9.3.5.md)
